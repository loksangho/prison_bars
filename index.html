<html>

<body>
	
		<canvas crossOrigin="Anonymous" width="2119px" height="2195px" id="canvas"></canvas>
	

	<script>
	let params = (new URL(document.location)).searchParams;
	let url = params.get("url");
	console.log(url);
	var canvas = document.getElementById("canvas");
	var ctx = canvas.getContext("2d", {preserveDrawingBuffer: true});

	var img1 = loadImage(url, main);
	img1.setAttribute('crossOrigin', 'anonymous');
	var img2 = loadImage('./prison_bars.png', main);
	img2.setAttribute('crossOrigin', 'anonymous');


	var imagesLoaded = 0;

	function main() {
	    imagesLoaded += 1;

	    if(imagesLoaded == 2) {
	        // composite now
	        canvas.width = img1.width;
	        canvas.height = img1.height;
	        ctx.drawImage(img1, 0, 0);
	        //ctx.globalAlpha = 0.5;
	        ctx.drawImage(img2, 0, 0, img1.width, img1.height);
	        //canvas.width = img1.width;
	        //canvas.height = img1.height;
	        var image = canvas.toDataURL("image/png")
	        //.replace("image/png", "image/octet-stream");
			//var image = new Image();
			//image.onload = (function() {
				
			//	return image;
			//});
			//var image = canvas.toDataURL();
			//var aLink = document.createElement('a');
			//var evt = new Event("look", {"bubbles":true, "cancelable":false});
			//document.dispatchEvent(evt);
			//window.location.href = image;


			//var image = canvas.toDataURL("image/png")
			//.replace("image/png", "image/octet-stream"); 
			
			//aLink.download = 'image.png';
			//aLink.href = image;
			//aLink.dispatchEvent(evt);
			//aLink.click();
			//window.location.href = "image.png"
			img_element = document.createElement('img');
			img_element.src = image;
			document.body.appendChild(img_element);
			canvas.remove();
			//openBase64InNewTab(image, 'image/png');
			Array.prototype.slice.call(document.getElementsByTagName('script')).forEach(
			  function(item) {
			    item.remove();
			    // or item.parentNode.removeChild(item); for older browsers (Edge-)
			});

	    }
	}

	function openBase64InNewTab (data, mimeType) {
	    var byteCharacters = atob(data.split(',')[1]);
	    var byteNumbers = new Array(byteCharacters.length);
	    for (var i = 0; i < byteCharacters.length; i++) {
	        byteNumbers[i] = byteCharacters.charCodeAt(i);
	    }
	    var byteArray = new Uint8Array(byteNumbers);
	    var file = new Blob([byteArray], { type: mimeType + ';base64' });
	    var fileURL = URL.createObjectURL(file);
	    window.open(fileURL);
	}

	function loadImage(src, onload) {
	    var img = new Image();
	    img.onload = onload;
	    img.src = src;
	    return img;
	}


	</script>

	<script type="module">
	  // Import the functions you need from the SDKs you need
	  import { initializeApp } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-app.js";
	  import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.17.1/firebase-analytics.js";
	  // TODO: Add SDKs for Firebase products that you want to use
	  // https://firebase.google.com/docs/web/setup#available-libraries

	  // Your web app's Firebase configuration
	  // For Firebase JS SDK v7.20.0 and later, measurementId is optional
	  const firebaseConfig = {
	    apiKey: "AIzaSyD4PwmZks4I1SlHIh0_scwenYjA5TAW6UA",
	    authDomain: "javascript-project-893c4.firebaseapp.com",
	    projectId: "javascript-project-893c4",
	    storageBucket: "javascript-project-893c4.appspot.com",
	    messagingSenderId: "998765410703",
	    appId: "1:998765410703:web:d954120ed5f2cd80a133fa",
	    measurementId: "G-C5M8TF6P4C"
	  };

	  // Initialize Firebase
	  const app = initializeApp(firebaseConfig);
	  const analytics = getAnalytics(app);
	</script>
</body>

</html>

